<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; amebadplus_docs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/toggleprompt.js?v=d7ede5d2"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="CHIP Enable" href="../../chip_en/src/index.html" />
    <link rel="prev" title="OTA Firmware Update" href="index.html" />  
     
  <script type="text/javascript" src="../../../_static/js/selector.js"></script>
<style>
      .wy-nav-content {
      max-width: 1000px; /* 设置最大宽度 */
      }
</style>



</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            amebadplus_docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/at_command/src/index.html">AT Command</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Application Note</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../gcc_build_environment/src/index.html">GCC Build Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdk_architecture/src/index.html">SDK Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gcc_makefile/src/index.html">GCC Makefile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdk_example/src/index.html">SDK Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flash_memory_layout/index.html">Flash and Memory Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mpu_cache/src/index.html">MPU and Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../file_system/src/index.html">Virtual File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mp_image/src/index.html">MP Image</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">OTA Firmware Update</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#image-slot">Image Slot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#version-number">Version Number</a></li>
<li class="toctree-l4"><a class="reference internal" href="#anti-rollback">Anti-rollback</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bootloader">Bootloader</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ota-image">OTA Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ota-select-flow">OTA Select Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#application">Application</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">OTA Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ota-selection-flow">OTA Selection Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-ota-image">Building OTA Image</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#modifying-configurations">Modifying Configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generating-ota-image-automatically">Generating OTA Image Automatically</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updating-from-local-server">Updating from Local Server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#firmware-format">Firmware Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ota-flow">OTA Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ota-demo">OTA Demo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ota-firmware-swap">OTA Firmware Swap</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-configuration">User Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../chip_en/src/index.html">CHIP Enable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boot_process/src/index.html">Boot Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_config/src/index.html">User Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hardware_crypto_engine/src/index.html">Hardware Crypto Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../otpc/src/index.html">One-time Programmable Controller (OTPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../power_save/src/index.html">Power Saving</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ipc/src/index.html">Inter-Processor Communication (IPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dmac/src/index.html">Direct Memory Access Controller (DMAC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../psram/src/index.html">Pseudo-Static Random Access Memory (PSRAM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gpio/gpio/src/index.html">General Purpose Input/Output (GPIO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gpio/pinctrl/src/index.html">Pin Controller (Pinctrl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pinmux/src/index.html">Pin Multiplexing Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rtc_io/src/index.html">RTC_IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ir/src/index.html">Infrared Radiation (IR)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ledc/src/index.html">Light Emitting Diode Controller (LEDC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../trng/src/index.html">True Random Number Generator (TRNG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../adc/src/index.html">Analog-to-Digital Converter (ADC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cap_touch/src/index.html">Cap-Touch Controller (CTC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../key_scan/src/index.html">Key-Scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../audio/src/index.html">Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usb_otg/src/index.html">USB OTG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../wifi/index.html">Wi-Fi</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/software_tools/index.html">Software Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/mp_tools/src/index.html">MP Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">amebadplus_docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Application Note</a></li>
          <li class="breadcrumb-item"><a href="index.html">OTA Firmware Update</a></li>
      <li class="breadcrumb-item active">Introduction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/application_note/ota/src/ota.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<span id="ota-firmware-update"></span><h1>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h1>
<p>Over-the-air (OTA) programming provides a methodology of updating device firmware remotely via TCP/IP network. For OTA via TCP/IP network, the AmebaDPlus provides solutions to implement OTA firmware upgrade from local server or cloud.</p>
<section id="image-slot">
<span id="id1"></span><h2>Image Slot<a class="headerlink" href="#image-slot" title="Link to this heading"></a></h2>
<p>There are two slots for all the images in the Flash layout as shown in below, which named OTA1 and OTA2 respectively. Each image can be chosen to boot from OTA1 or OTA2.</p>
<figure class="align-center" id="id4">
<a class="reference internal image-reference" href="../../../_images/ota1_and_ota2_position.svg"><img alt="../../../_images/ota1_and_ota2_position.svg" height="238" src="../../../_images/ota1_and_ota2_position.svg" width="176" /></a>
<figcaption>
<p><span class="caption-text">OTA1 and OTA2 position</span><a class="headerlink" href="#id4" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="version-number">
<span id="id2"></span><h2>Version Number<a class="headerlink" href="#version-number" title="Link to this heading"></a></h2>
<p>The device boot from OTA1 or OTA2 mainly depends on the version number in certificate and manifest.
As shown in the figure below, there is a 2-byte major version and 2-byte minor version in manifest and certificate.</p>
<figure class="align-center" id="id5">
<a class="reference internal image-reference" href="../../../_images/major_and_minor_version.svg"><img alt="../../../_images/major_and_minor_version.svg" height="387" src="../../../_images/major_and_minor_version.svg" width="805" /></a>
<figcaption>
<p><span class="caption-text">Major and minor version</span><a class="headerlink" href="#id5" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The combination of major version and minor version is the 4-byte version number. OTA select flow checks the whole version number.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Version</span> <span class="n">number</span> <span class="o">=</span> <span class="p">(</span><span class="n">Major</span> <span class="n">version</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">Minor</span> <span class="n">version</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>For bootloader, version number can be 0 to 32767; for application, version number can be 0 to 65535.</p></li>
</ul>
</div>
<p>As described in <a class="reference internal" href="#image-slot"><span class="std std-ref">Image Slot</span></a>, there are two slots (OTA1 and OTA2) for all the images in the Flash layout. When reboot after OTA upgrade finished, the device would check the image to determine to boot from OTA1 or OTA2.</p>
<p>The general principle of the OTA scheme is checking the image pattern first and then comparing the version number of OTA1 and OTA2.</p>
<p>The following items must be checked for each image:</p>
<ol class="arabic">
<li><p>Check the image pattern for both OTA1 and OTA2.</p>
<ul class="simple">
<li><p>If only one image pattern is valid, boot from the valid image.</p></li>
<li><p>If both the image pattern are invalid, boot fail.</p></li>
</ul>
</li>
<li><p>Compare the version number of OTA1 and OTA2.</p>
<ul class="simple">
<li><p>If both OTA1 and OTA2 are valid and with different version numbers, the device will boot from the image with a bigger version.</p></li>
<li><p>If both OTA1 and OTA2 are valid but with the same version number, the device will boot from OTA1.</p></li>
</ul>
<figure class="align-center" id="id6">
<a class="reference internal image-reference" href="../../../_images/ota_select_diagram.svg"><img alt="../../../_images/ota_select_diagram.svg" height="249" src="../../../_images/ota_select_diagram.svg" width="669" /></a>
<figcaption>
<p><span class="caption-text">OTA selection diagram</span><a class="headerlink" href="#id6" title="Link to this image"></a></p>
</figcaption>
</figure>
</li>
</ol>
</section>
<section id="anti-rollback">
<h2>Anti-rollback<a class="headerlink" href="#anti-rollback" title="Link to this heading"></a></h2>
<p>Anti-rollback is the function to prevent version rollback attack.
When the anti-rollback is enabled, the version number in certificate or manifest must not be smaller than the anti-rollback version stored in OTP.
Otherwise, this image will be regarded as invalid and the chip will not boot from invalid image.
Normally, if OTA update is security-related, user can program a bigger anti-rollback version number in OTP and
update image with a bigger major version at the same time to prevent rollback attack.</p>
<p>The anti-rollback flow is shown below.
Once the anti-rollback is enabled, the device will compare the major version numbers got from OTA1 and OTA2 images respectively with the anti-rollback version number in OTP.
If the major version number in the image is smaller than the anti-rollback version number, this image will be regarded as invalid.</p>
<figure class="align-center" id="id7">
<a class="reference internal image-reference" href="../../../_images/anti_rollback_flow.svg"><img alt="../../../_images/anti_rollback_flow.svg" height="302" src="../../../_images/anti_rollback_flow.svg" width="660" /></a>
<figcaption>
<p><span class="caption-text">Anti-rollback flow</span><a class="headerlink" href="#id7" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="bootloader">
<h1>Bootloader<a class="headerlink" href="#bootloader" title="Link to this heading"></a></h1>
<section id="ota-image">
<h2>OTA Image<a class="headerlink" href="#ota-image" title="Link to this heading"></a></h2>
<p>The KM4 bootloader image named <code class="file docutils literal notranslate"><span class="pre">km4_boot_all.bin</span></code> can be updated through OTA, which can be chosen to boot from OTA1 or OTA2.
The layout of KM4 bootloader image is illustrated below.</p>
<figure class="align-center" id="id8">
<a class="reference internal image-reference" href="../../../_images/layout_of_km4_bootloader_image.svg"><img alt="../../../_images/layout_of_km4_bootloader_image.svg" height="66" src="../../../_images/layout_of_km4_bootloader_image.svg" width="301" /></a>
<figcaption>
<p><span class="caption-text">Layout of KM4 bootloader image</span><a class="headerlink" href="#id8" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="ota-select-flow">
<h2>OTA Select Flow<a class="headerlink" href="#ota-select-flow" title="Link to this heading"></a></h2>
<p>The KM4 ROM will select OTA image according to the image version number in bootloader manifest.</p>
<figure class="align-center" id="id9">
<a class="reference internal image-reference" href="../../../_images/km4_bootloader_ota_select_flow.svg"><img alt="../../../_images/km4_bootloader_ota_select_flow.svg" height="958" src="../../../_images/km4_bootloader_ota_select_flow.svg" width="926" /></a>
<figcaption>
<p><span class="caption-text">KM4 bootloader OTA selection flow</span><a class="headerlink" href="#id9" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="application">
<h1>Application<a class="headerlink" href="#application" title="Link to this heading"></a></h1>
<section id="id3">
<h2>OTA Image<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<p>The application image named <code class="file docutils literal notranslate"><span class="pre">km0_km4_app.bin</span></code>, including KM0, KM4 non-secure application image and KM4 secure image, can be updated through OTA,
which can be chosen to boot from OTA1 or OTA2. The layout of the whole application image is illustrated below.</p>
<figure class="align-center" id="id10">
<a class="reference internal image-reference" href="../../../_images/layout_of_application_image.svg"><img alt="../../../_images/layout_of_application_image.svg" height="115" src="../../../_images/layout_of_application_image.svg" width="301" /></a>
<figcaption>
<p><span class="caption-text">Layout of application image</span><a class="headerlink" href="#id10" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="ota-selection-flow">
<h2>OTA Selection Flow<a class="headerlink" href="#ota-selection-flow" title="Link to this heading"></a></h2>
<p>The application image OTA selection flow is illustrated below.</p>
<figure class="align-center" id="id11">
<a class="reference internal image-reference" href="../../../_images/application_image_ota_select_flow.svg"><img alt="../../../_images/application_image_ota_select_flow.svg" height="764" src="../../../_images/application_image_ota_select_flow.svg" width="930" /></a>
<figcaption>
<p><span class="caption-text">Application image OTA selection flow</span><a class="headerlink" href="#id11" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="building-ota-image">
<h1>Building OTA Image<a class="headerlink" href="#building-ota-image" title="Link to this heading"></a></h1>
<section id="modifying-configurations">
<span id="ota-modifying-configurations"></span><h2>Modifying Configurations<a class="headerlink" href="#modifying-configurations" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Modify the version number in configuration file <code class="file docutils literal notranslate"><span class="pre">manifest.json</span></code> under <code class="docutils literal notranslate"><span class="pre">{SDK}\amebadplus_gcc_project</span></code>.</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>File</p></th>
<th class="head"><p>Tag</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="2"><p>manifest.json</p></td>
<td><p>boot</p></td>
<td><p>Configure major and minor version for KM4 bootloader</p></td>
</tr>
<tr class="row-odd"><td><p>app</p></td>
<td><p>Configure major and minor version for certificate and application</p></td>
</tr>
</tbody>
</table>
<ol class="loweralpha">
<li><p>Modify the version number for bootloader.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;boot&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">           </span><span class="nt">&quot;IMG_ID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
<span class="hll"><span class="w">           </span><span class="nt">&quot;IMG_VER_MAJOR&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll"><span class="w">           </span><span class="nt">&quot;IMG_VER_MINOR&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span>
<span class="w">           </span><span class="nt">&quot;SEC_EPOCH&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>

<span class="w">           </span><span class="nt">&quot;HASH_ALG&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256&quot;</span><span class="p">,</span>

<span class="w">           </span><span class="nt">&quot;RSIP_IV&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;01020304050607080000000000000000&quot;</span>
<span class="w">   </span><span class="p">},</span>
</pre></div>
</div>
</li>
<li><p>Modify the version number for certificate and application.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;app&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">           </span><span class="nt">&quot;IMG_ID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="hll"><span class="w">           </span><span class="nt">&quot;IMG_VER_MAJOR&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll"><span class="w">           </span><span class="nt">&quot;IMG_VER_MINOR&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span>
<span class="w">           </span><span class="nt">&quot;SEC_EPOCH&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>

<span class="w">           </span><span class="nt">&quot;HASH_ALG&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256&quot;</span><span class="p">,</span>

<span class="w">           </span><span class="nt">&quot;RSIP_IV&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;213253647586a7b80000000000000000&quot;</span>
<span class="w">   </span><span class="p">},</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p>Change the bootloader version of anti-rollback and enable anti-rollback if necessary.</p>
<ol class="loweralpha">
<li><p>Change the bootloader version of anti-rollback</p>
<p>By default, all images use the same anti-rollback version in OTP as threshold to prevent anti-rollback attack.</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>OTP address</p></th>
<th class="head"><p>Length</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BOOTLOADER_VERSION</p></td>
<td><p>Physical 0x36E~0x36F</p></td>
<td><p>16 bits</p></td>
<td><p>Bootloader version of anti-rollback</p></td>
</tr>
</tbody>
</table>
<dl class="simple">
<dt>The bootloader version of anti-rollback is 0 by default. Users can change the number of ‘0’ bit to enlarge the bootloader version.</dt><dd><p>For example, users can program the bootloader version of anti-rollback to 1 by the following command:</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EFUSE</span> <span class="n">wraw</span> <span class="mi">36</span><span class="n">E</span> <span class="mi">2</span> <span class="n">FFFE</span>
</pre></div>
</div>
</li>
<li><p>Enable anti-rollback</p>
<p>Users can program OTP by the following command to enable anti-rollback.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EFUSE</span> <span class="n">wraw</span> <span class="mi">368</span> <span class="mi">1</span> <span class="n">BF</span>
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>Once anti-rollback is enabled, it cannot be disabled.</p></li>
<li><p>If bootloader and application do not use the same anti-rollback version, modify <code class="xref py py-func docutils literal notranslate"><span class="pre">BOOT_OTA_GetCertRollbackVer()</span></code> in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\soc\amebadplus\bootloader\boot_ota_km4.c</span></code> and define another anti-rollback version in OTP for the application.</p></li>
</ul>
</div>
</li>
<li><p>Write the bootloader OTA2 address into OTP if users need to upgrade the bootloader, which sets the bootloader OTA2 address according to <em>Flash_Layout</em> in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\soc\amebadplus\usrcfg\ameba_flashcfg.c</span></code>, refer to <a class="reference internal" href="#ota-user-configuration"><span class="std std-ref">User Configuration</span></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EFUSE</span> <span class="n">wraw</span> <span class="mi">36</span><span class="n">C</span> <span class="mi">2</span> <span class="mi">6082</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The address of bootloader OTA2 is the value of OTP 0x36C with 12-bit left shifted, or is the value of OTP 0x36C * 4K.</p></li>
<li><p>If the address of bootloader OTA2 is 0xFFFFFFFF by default, the bootloader won’t be upgraded when in OTA upgrade and the device always boots from bootloader OTA1.</p></li>
<li><p>The above commands are used in the serial terminal tool.</p></li>
</ul>
</div>
</li>
<li><p>Rebuild the project using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span></code> command to generate the signed images.</p></li>
<li><p>Download the images into Flash, and reset the board.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">MODULE_BOOT</span><span class="o">-</span><span class="n">LEVEL_INFO</span><span class="p">]:</span> <span class="n">KM0</span> <span class="n">PSRAM</span><span class="p">[</span><span class="mi">0</span><span class="n">c051b60</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
    <span class="p">[</span><span class="n">MODULE_BOOT</span><span class="o">-</span><span class="n">LEVEL_INFO</span><span class="p">]:</span> <span class="n">KM0</span> <span class="n">BOOT</span><span class="p">[</span><span class="mi">20004</span><span class="n">d00</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span>
    <span class="p">[</span><span class="n">MODULE_BOOT</span><span class="o">-</span><span class="n">LEVEL_INFO</span><span class="p">]:</span> <span class="n">KM4</span> <span class="n">XIP</span> <span class="n">IMG</span><span class="p">[</span><span class="mf">0e000000</span><span class="p">:</span><span class="mi">5</span><span class="n">ad80</span><span class="p">]</span>
    <span class="p">[</span><span class="n">MODULE_BOOT</span><span class="o">-</span><span class="n">LEVEL_INFO</span><span class="p">]:</span> <span class="n">KM4</span> <span class="n">SRAM</span><span class="p">[</span><span class="mi">20010000</span><span class="p">:</span><span class="mi">13</span><span class="n">c0</span><span class="p">]</span>
    <span class="p">[</span><span class="n">MODULE_BOOT</span><span class="o">-</span><span class="n">LEVEL_INFO</span><span class="p">]:</span> <span class="n">KM4</span> <span class="n">PSRAM</span><span class="p">[</span><span class="mf">0e05</span><span class="n">c140</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
<span class="hll">    <span class="p">[</span><span class="n">MODULE_BOOT</span><span class="o">-</span><span class="n">LEVEL_INFO</span><span class="p">]:</span> <span class="n">IMG2</span> <span class="n">BOOT</span> <span class="kn">from</span> <span class="nn">OTA</span> <span class="mi">1</span>
</span>    <span class="p">[</span><span class="n">MODULE_BOOT</span><span class="o">-</span><span class="n">LEVEL_INFO</span><span class="p">]:</span> <span class="n">Start</span> <span class="n">NonSecure</span> <span class="o">@</span> <span class="mh">0xe001715</span> <span class="o">...</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="generating-ota-image-automatically">
<h2>Generating OTA Image Automatically<a class="headerlink" href="#generating-ota-image-automatically" title="Link to this heading"></a></h2>
<p>The OTA image will be generated automatically when building the project.</p>
<ol class="arabic simple">
<li><p>The <code class="file docutils literal notranslate"><span class="pre">km0_km4_app.bin</span></code> is included in <code class="file docutils literal notranslate"><span class="pre">ota_all.bin</span></code> by default.</p></li>
<li><p>If the bootloader is needed to be upgraded,</p>
<ol class="loweralpha simple">
<li><p>Type command <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">menuconfig</span></code> under <code class="docutils literal notranslate"><span class="pre">{SDK}\amebadplus_gcc_project</span></code> and choose <span class="menuselection">CONFIG OTA OPTION -&gt; Upgrade Bootloader</span>, save and exit.</p></li>
<li><p>Modify the bootloader related configurations as described in Section <a class="reference internal" href="#ota-modifying-configurations"><span class="std std-ref">Modifying Configurations</span></a>.</p></li>
</ol>
</li>
<li><p>Rebuild the project by command <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span></code> under <code class="docutils literal notranslate"><span class="pre">{SDK}\amebadplus_gcc_project</span></code>. The OTA image file called <code class="file docutils literal notranslate"><span class="pre">ota_all.bin</span></code> will be generated under <code class="docutils literal notranslate"><span class="pre">{SDK}\amebadplus_gcc_project</span></code>.</p></li>
</ol>
</section>
</section>
<section id="updating-from-local-server">
<h1>Updating from Local Server<a class="headerlink" href="#updating-from-local-server" title="Link to this heading"></a></h1>
<p>This section introduces the design principles and usage of OTA from local server.
It has well-transportability to porting to OTA applications from cloud.</p>
<p>The OTA from local server shows how the device updates the image from a local download server.
The local download server sends the image to the device based on the network socket, as the following figure illustrates.</p>
<figure class="align-center" id="id12">
<a class="reference internal image-reference" href="../../../_images/ota_update_diagram_via_network.svg"><img alt="../../../_images/ota_update_diagram_via_network.svg" height="161" src="../../../_images/ota_update_diagram_via_network.svg" width="821" /></a>
<figcaption>
<p><span class="caption-text">OTA update diagram via network</span><a class="headerlink" href="#id12" title="Link to this image"></a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure both the device and the PC are connecting to the same local network.</p>
</div>
<section id="firmware-format">
<h2>Firmware Format<a class="headerlink" href="#firmware-format" title="Link to this heading"></a></h2>
<p>The firmware format is illustrated below.</p>
<figure class="align-center" id="id13">
<a class="reference internal image-reference" href="../../../_images/firmware_format.svg"><img alt="../../../_images/firmware_format.svg" height="285" src="../../../_images/firmware_format.svg" width="1075" /></a>
<figcaption>
<p><span class="caption-text">Firmware format</span><a class="headerlink" href="#id13" title="Link to this image"></a></p>
</figcaption>
</figure>
<table class="docutils align-default" id="id14" style="width: 100%">
<caption><span class="caption-text">Firmware header</span><a class="headerlink" href="#id14" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Items</p></th>
<th class="head"><p>Address offset</p></th>
<th class="head"><p>Size</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Version</p></td>
<td><p>0x00</p></td>
<td><p>4 bytes</p></td>
<td><p>Version of OTA Header, default is 0xFFFFFFFF.</p></td>
</tr>
<tr class="row-odd"><td><p>Header Number</p></td>
<td><p>0x04</p></td>
<td><p>4 bytes</p></td>
<td><p>Number of OTA Header. For AmebaDPlus, this value can be 1, 2.</p></td>
</tr>
<tr class="row-even"><td><p>Signature</p></td>
<td><p>0x08</p></td>
<td><p>4 bytes</p></td>
<td><p>OTA signature is string. For AmebaDPlus, this value is <code class="docutils literal notranslate"><span class="pre">OTA</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p>Header Length</p></td>
<td><p>0x0C</p></td>
<td><p>4 bytes</p></td>
<td><p>Length of OTA header. For AmebaDPlus, this value is 0x18.</p></td>
</tr>
<tr class="row-even"><td><p>Checksum</p></td>
<td><p>0x10</p></td>
<td><p>4 bytes</p></td>
<td><p>Checksum of OTA image</p></td>
</tr>
<tr class="row-odd"><td><p>Image Length</p></td>
<td><p>0x14</p></td>
<td><p>4 bytes</p></td>
<td><p>Size of OTA image</p></td>
</tr>
<tr class="row-even"><td><p>Offset</p></td>
<td><p>0x18</p></td>
<td><p>4 bytes</p></td>
<td><p>Start position of OTA image in current image</p></td>
</tr>
<tr class="row-odd"><td><p>Image ID</p></td>
<td><p>0x1C</p></td>
<td><p>4 bytes</p></td>
<td><p>Image ID of current image</p>
<ul class="simple">
<li><p>OTA_IMGID_BOOT: 0x0</p></li>
<li><p>OTA_IMGID_APP: 0x1</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</section>
<section id="ota-flow">
<h2>OTA Flow<a class="headerlink" href="#ota-flow" title="Link to this heading"></a></h2>
<p>The OTA demo is located at <code class="docutils literal notranslate"><span class="pre">{SDK}\component\soc\amebadplus\misc\ameba_ota.c</span></code>.
The image upgrade is implemented in the following steps:</p>
<ol class="arabic">
<li><p>Connect to the server. The IP address, port and OTA type are needed.</p></li>
<li><p>Acquire the older firmware address to be upgraded according to the MMU setting.</p>
<p>If the address is re-mapping to OTA1 space by MMU, the OTA2 address would be selected to upgrade. Otherwise, the OTA1 address would be selected.</p>
</li>
<li><p>Receive the firmware file header to get the target OTA image information, such as image number, image length and image ID.</p></li>
<li><p>Download the new firmware from server.</p></li>
<li><p>Erase the Flash space for new firmware and write it into Flash except Manifest structure.</p></li>
<li><p>Verify the checksum.</p>
<p>If the checksum is error, OTA fails.</p>
</li>
<li><p>If the checksum is ok, write Manifest structure to the upgraded firmware region to indicate boot from a new firmware next time.</p></li>
<li><p>OTA is finished. Reset the device, and it would boot from the new firmware.</p></li>
</ol>
<figure class="align-center" id="id15">
<a class="reference internal image-reference" href="../../../_images/ota_operation_flow.svg"><img alt="../../../_images/ota_operation_flow.svg" height="884" src="../../../_images/ota_operation_flow.svg" width="847" /></a>
<figcaption>
<p><span class="caption-text">OTA operation flow</span><a class="headerlink" href="#id15" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="ota-demo">
<h1>OTA Demo<a class="headerlink" href="#ota-demo" title="Link to this heading"></a></h1>
<p>Follow these steps to run the OTA demo to update from local server:</p>
<ol class="arabic">
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">{SDK}\component\example\ota\example_ota.c</span></code>.</p>
<ol class="loweralpha">
<li><p>Edit the host according to the server IP address.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define PORT   8082</span>
<span class="n">static</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;192.168.31.193&quot;</span><span class="p">;</span>   <span class="o">//</span><span class="s2">&quot;m-apps.oss-cn-shenzhen.aliyuncs.com&quot;</span>
<span class="n">static</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">resource</span> <span class="o">=</span> <span class="s2">&quot;ota_all.bin&quot;</span><span class="p">;</span> <span class="o">//</span><span class="s2">&quot;051103061600.bin&quot;</span>
</pre></div>
</div>
</li>
<li><p>Edit the OTA type to <code class="docutils literal notranslate"><span class="pre">OTA_LOCAL</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">ota_update_init</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">resource</span><span class="p">,</span> <span class="n">OTA_LOCAL</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</li>
</ol>
<ol class="arabic" id="ota-demo-step-2" start="2">
<li><p>Rebuild the project with the command <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span> <span class="pre">EXAMPLE=ota</span></code> and download the images to the device.</p></li>
<li><p>Modify the major and minor version number in Manifest to a bigger version as described in <a class="reference internal" href="#version-number"><span class="std std-ref">Version Number</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The bootloader will select OTA image with a bigger version number by default. If users don’t want to modify the version number, modify <em>OTA_CLEAR_PATTERN</em> to 1 defined in <code class="file docutils literal notranslate"><span class="pre">ameba_ota.h</span></code> before <a class="reference internal" href="#ota-demo-step-2"><span class="std std-ref">Step 2</span></a>. It should only be used in the development stage.</p>
</div>
</li>
<li><p>Rebuild the project and copy <code class="docutils literal notranslate"><span class="pre">ota_all.bin</span></code> into <code class="docutils literal notranslate"><span class="pre">{SDK}\tools\DownloadServer</span></code>.</p></li>
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">{SDK}\tools\DownloadServer\start.bat</span></code>.</p>
<ul class="simple">
<li><p>port = 8082</p></li>
<li><p>file name = ota_all.bin</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@echo</span> <span class="n">off</span>
<span class="n">DownloadServer</span> <span class="mi">8082</span> <span class="n">ota_all</span><span class="o">.</span><span class="n">bin</span>
<span class="nb">set</span> <span class="o">/</span><span class="n">p</span> <span class="n">DUMMY</span><span class="o">=</span><span class="n">Press</span> <span class="n">Enter</span> <span class="n">to</span> <span class="n">Continue</span> <span class="o">...</span>
</pre></div>
</div>
</li>
<li><p>Click <code class="file docutils literal notranslate"><span class="pre">start.bat</span></code>, and start the download server program.</p></li>
<li><p>Reboot the DUT and connect the device to the AP which the OTA server is in.</p></li>
<li><p>Reboot the DUT to execute the new firmware after finishing image download.</p></li>
</ol>
</section>
<section id="ota-firmware-swap">
<h1>OTA Firmware Swap<a class="headerlink" href="#ota-firmware-swap" title="Link to this heading"></a></h1>
<p>The following figure shows the firmware swap procedure after OTA upgrade.</p>
<figure class="align-center" id="id16">
<a class="reference internal image-reference" href="../../../_images/ota_firmware_swap_procedure.svg"><img alt="../../../_images/ota_firmware_swap_procedure.svg" height="474" src="../../../_images/ota_firmware_swap_procedure.svg" width="713" /></a>
<figcaption>
<p><span class="caption-text">OTA firmware swap procedure</span><a class="headerlink" href="#id16" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="user-configuration">
<span id="ota-user-configuration"></span><h1>User Configuration<a class="headerlink" href="#user-configuration" title="Link to this heading"></a></h1>
<p>Modify the memory layout in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\soc\amebadplus\usrcfg\ameba_flashcfg.c</span></code> if needed.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm">* @brif      Flash layout is set according to Flash Layout in User Manual</span>
<span class="linenos"> 3</span><span class="cm">*  In each entry, the first item is flash regoin type, the second item is start address, the second item is end address */</span>
<span class="linenos"> 4</span><span class="k">const</span><span class="w"> </span><span class="n">FlashLayoutInfo_TypeDef</span><span class="w"> </span><span class="n">Flash_Layout</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">   </span><span class="cm">/*Region_Type,    [StartAddr,     EndAddr]                */</span>
<span class="linenos"> 6</span><span class="w">   </span><span class="p">{</span><span class="n">IMG_BOOT</span><span class="p">,</span><span class="w">                </span><span class="mh">0x08000000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08013FFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//Boot Manifest(4K) + KM4 Bootloader(76K)</span>
<span class="linenos"> 7</span><span class="w">   </span><span class="c1">//Users should modify below according to their own memory</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">   </span><span class="p">{</span><span class="n">IMG_APP_OTA1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08014000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x081F3FFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//Certificate(4K) + Manifest(4K) + KM4 Application OTA1 + Manifest(4K) + RDP IMG OTA1</span>
</span><span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">   </span><span class="p">{</span><span class="n">IMG_BOOT_OTA2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08200000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08213FFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//Boot Manifest(4K) + KM4 Bootloader(76K) OTA</span>
<span class="hll"><span class="linenos">11</span><span class="w">   </span><span class="p">{</span><span class="n">IMG_APP_OTA2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08214000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x083F3FFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//Certificate(4K) + Manifest(4K) + KM4 Application OTA2 + Manifest(4K) + RDP IMG OTA2</span>
</span><span class="linenos">12</span>
<span class="linenos">13</span><span class="w">   </span><span class="p">{</span><span class="n">FTL</span><span class="p">,</span><span class="w">                     </span><span class="mh">0x08700000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08702FFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//FTL for BT(&gt;=12K), The start offset of flash pages which is allocated to FTL physical map.</span>
<span class="linenos">14</span><span class="w">   </span><span class="p">{</span><span class="n">VFS1</span><span class="p">,</span><span class="w">                    </span><span class="mh">0x08703000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08722FFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//VFS region 1 (128K)</span>
<span class="linenos">15</span><span class="w">   </span><span class="p">{</span><span class="n">USER</span><span class="p">,</span><span class="w">                    </span><span class="mh">0xFFFFFFFF</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//reserve for user</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">   </span><span class="cm">/* End */</span>
<span class="linenos">18</span><span class="w">   </span><span class="p">{</span><span class="mh">0xFF</span><span class="p">,</span><span class="w">                    </span><span class="mh">0xFFFFFFFF</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="p">},</span>
<span class="linenos">19</span><span class="p">};</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="OTA Firmware Update" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../chip_en/src/index.html" class="btn btn-neutral float-right" title="CHIP Enable" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Realsil.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>