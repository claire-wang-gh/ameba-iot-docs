<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; amebadplus_docs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/toggleprompt.js?v=d7ede5d2"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Audio" href="../../audio/src/index.html" />
    <link rel="prev" title="Key-Scan" href="index.html" />  
     
  <script type="text/javascript" src="../../../_static/js/selector.js"></script>
<style>
      .wy-nav-content {
      max-width: 1000px; /* 设置最大宽度 */
      }
</style>



</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            amebadplus_docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/at_command/src/index.html">AT Command</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Application Note</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../gcc_build_environment/src/index.html">GCC Build Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdk_architecture/src/index.html">SDK Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gcc_makefile/src/index.html">GCC Makefile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdk_example/src/index.html">SDK Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flash_memory_layout/index.html">Flash and Memory Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mpu_cache/src/index.html">MPU and Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../file_system/src/index.html">Virtual File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mp_image/src/index.html">MP Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ota/src/index.html">OTA Firmware Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chip_en/src/index.html">CHIP Enable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boot_process/src/index.html">Boot Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_config/src/index.html">User Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hardware_crypto_engine/src/index.html">Hardware Crypto Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../otpc/src/index.html">One-time Programmable Controller (OTPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../power_save/src/index.html">Power Saving</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ipc/src/index.html">Inter-Processor Communication (IPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dmac/src/index.html">Direct Memory Access Controller (DMAC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../psram/src/index.html">Pseudo-Static Random Access Memory (PSRAM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gpio/gpio/src/index.html">General Purpose Input/Output (GPIO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gpio/pinctrl/src/index.html">Pin Controller (Pinctrl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pinmux/src/index.html">Pin Multiplexing Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rtc_io/src/index.html">RTC_IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ir/src/index.html">Infrared Radiation (IR)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ledc/src/index.html">Light Emitting Diode Controller (LEDC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../trng/src/index.html">True Random Number Generator (TRNG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../adc/src/index.html">Analog-to-Digital Converter (ADC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cap_touch/src/index.html">Cap-Touch Controller (CTC)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Key-Scan</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#block-diagram">Block Diagram</a></li>
<li class="toctree-l4"><a class="reference internal" href="#keypad">Keypad</a></li>
<li class="toctree-l4"><a class="reference internal" href="#work-mode">Work Mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fifo-mechanism">FIFO Mechanism</a></li>
<li class="toctree-l4"><a class="reference internal" href="#low-power">Low Power</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stuck-key">Stuck Key</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#event-trigger-mode">Event Trigger Mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#regular-scan-mode">Regular Scan Mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#key-stuck">Key Stuck</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../audio/src/index.html">Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usb_otg/src/index.html">USB OTG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../wifi/index.html">Wi-Fi</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/software_tools/index.html">Software Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/mp_tools/src/index.html">MP Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">amebadplus_docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Application Note</a></li>
          <li class="breadcrumb-item"><a href="index.html">Key-Scan</a></li>
      <li class="breadcrumb-item active">Introduction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/application_note/key_scan/src/key_scan.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<span id="key-scan"></span><h1>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h1>
<p>As a keypad scan device, Key-Scan supports up to 8*8 keypad array, and its rows and columns are configurable. Key-Scan supports multi-key detect, and it can work in low power mode.</p>
<section id="block-diagram">
<h2>Block Diagram<a class="headerlink" href="#block-diagram" title="Link to this heading"></a></h2>
<p>The block diagram of Key-Scan is illustrated in the following figure.</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="../../../_images/key_scan_block_diagram.svg"><img alt="../../../_images/key_scan_block_diagram.svg" height="252" src="../../../_images/key_scan_block_diagram.svg" width="611" /></a>
<figcaption>
<p><span class="caption-text">Key-Scan block diagram</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Key-Scan contains 6 main parts:</p>
<ul class="simple">
<li><p><strong>Interrupt control</strong>: control and manage interrupts.</p></li>
<li><p><strong>Register and FIFO</strong>: configure Key-Scan parameters and FIFO.</p></li>
<li><p><strong>Clock</strong>: Key-Scan clock, 131K clock is used for stuck row detect.</p></li>
<li><p><strong>Keypad control</strong>: contains Key-Scan control, wake up control and key input/output control.</p></li>
<li><p><strong>Keypad</strong>: up to 8*8 keypad array with use of 16 GPIOs</p></li>
</ul>
</section>
<section id="keypad">
<h2>Keypad<a class="headerlink" href="#keypad" title="Link to this heading"></a></h2>
<p>The columns and rows of Key-Scan are configurable, and the maximum columns or rows can be as 8.</p>
<figure class="align-center" id="keypad-array">
<a class="reference internal image-reference" href="../../../_images/keypad_array.svg"><img alt="../../../_images/keypad_array.svg" height="705" src="../../../_images/keypad_array.svg" width="830" /></a>
<figcaption>
<p><span class="caption-text">Keypad array</span><a class="headerlink" href="#keypad-array" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>At the beginning, all columns output low, and all rows are set as input with internal pull up.
When there is a key or multiple keys pressed (short between the Column and the Row), it triggers an internal state machine to start a Key-Scan cycle to determine the column and row of the key that is pressed.
The state machine sets first column as an output low and all other columns are in Hi-Z state. The state machine then scans all rows to determine which keys are being pressed, and then second column is output low until the last column.</p>
</section>
<section id="work-mode">
<h2>Work Mode<a class="headerlink" href="#work-mode" title="Link to this heading"></a></h2>
<p>Key-Scan contains two work modes: Event Trigger Mode and Regular Scan Mode. The following figure shows the difference of FIFO items between Event Trigger Mode and Regular Scan Mode during a key press and release.</p>
<ul class="simple">
<li><p>In Event Trigger Mode, key press or release event is stored in the key event FIFO only once in each key press and release operation.</p></li>
<li><p>In Regular Scan Mode, at each full scan, any key press event is stored in the key event FIFO until it is released (in this condition, only key press event is stored in the key event FIFO).</p></li>
</ul>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="../../../_images/difference_FIFO_items_between_two_work_modes.svg"><img alt="../../../_images/difference_FIFO_items_between_two_work_modes.svg" height="341" src="../../../_images/difference_FIFO_items_between_two_work_modes.svg" width="500" /></a>
<figcaption>
<p><span class="caption-text">Difference of FIFO items between two work modes</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="fifo-mechanism">
<h2>FIFO Mechanism<a class="headerlink" href="#fifo-mechanism" title="Link to this heading"></a></h2>
<p>The FIFO depth of Key-Scan is 16, and the FIFO entry width is 12 bits. Its structure is illustrated in the following figure.</p>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="../../../_images/FIFO_structure.svg"><img alt="../../../_images/FIFO_structure.svg" height="54" src="../../../_images/FIFO_structure.svg" width="543" /></a>
<figcaption>
<p><span class="caption-text">FIFO structure</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<table class="docutils align-default" id="id4" style="width: 100%">
<caption><span class="caption-text">FIFO Structure</span><a class="headerlink" href="#id4" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Bit</p></th>
<th class="head"><p>Indication</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>[8]</p></td>
<td><p>Event</p></td>
<td><ul class="simple">
<li><p>1: key press event.</p></li>
<li><p>0: key release event.</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>[7:4]</p></td>
<td><p>Row index</p></td>
<td><ul class="simple">
<li><p>1: row 0</p></li>
<li><p>2: row 1</p></li>
<li><p>3: row 2</p></li>
<li><p>…</p></li>
<li><p>8: row 7</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>[3:0]</p></td>
<td><p>Column index</p></td>
<td><ul class="simple">
<li><p>1: column 0</p></li>
<li><p>2: column 1</p></li>
<li><p>3: column 2</p></li>
<li><p>…</p></li>
<li><p>8: column 7</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</section>
<section id="low-power">
<h2>Low Power<a class="headerlink" href="#low-power" title="Link to this heading"></a></h2>
<section id="active">
<h3>Active<a class="headerlink" href="#active" title="Link to this heading"></a></h3>
<p>In active mode, Key-Scan circuit keeps power on all the time. When Key-Scan scans column <em>x</em> (<em>x</em> is any column), it sets column <em>x</em> as an output low and all other columns are in Hi-Z state, then it scans all rows to determine which keys are being pressed or released, after this, one column scans end. Key-Scan scans column in sequence, and will be cyclic scanning column by column.</p>
</section>
<section id="sleep">
<h3>Sleep<a class="headerlink" href="#sleep" title="Link to this heading"></a></h3>
<p>In practical application scenarios, Key-Scan keeps active is high power consumption. To save power consumption and optimize application, Key-Scan often works in sleep mode.</p>
<p>In sleep mode, CPU enter in low power state, but when a key or keys are pressed, it will wake up CPU and then Key-Scan will start to scan to determine which keys are being pressed. Key-Scan keeps scanning when keys are pressed, after keys are released and there is no other event occurs, CPU sleeps again.</p>
</section>
</section>
<section id="stuck-key">
<h2>Stuck Key<a class="headerlink" href="#stuck-key" title="Link to this heading"></a></h2>
<p>Key stuck may occur in some applications. In this case, if there is no solution in reply to key stuck, CPU will keep active to perform continuous keypad scans, thus CPU cannot enter low power mode, which will result in high power consumption.</p>
<p>To solve this problem, the Key-Scan supports auto check key stuck function. When enabling this function, if a key stuck time is over than stuck time threshold, this key will be regarded as a stuck key. Read key stuck status registers to get the stuck key, and set the default status of the stuck key row to let CPU enter low power mode.</p>
<p>To lower the power consumption, stuck row detection function may be enabled to set row pins “no pull” detection time interval.</p>
</section>
</section>
<section id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Link to this heading"></a></h1>
<section id="event-trigger-mode">
<h2>Event Trigger Mode<a class="headerlink" href="#event-trigger-mode" title="Link to this heading"></a></h2>
<p>To use Key-Scan event trigger mode, perform the following procedures:</p>
<ol class="arabic">
<li><p>Configure Pinmux for Key-Scan keypads.</p>
<ol class="loweralpha">
<li><p>Set column pads to no-pull, and set column pinmux function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PAD_PullCtrl</span><span class="p">(</span><span class="n">pad_colx</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PuPd_NOPULL</span><span class="p">);</span>
<span class="n">Pinmux_Config</span><span class="p">(</span><span class="n">pad_colx</span><span class="p">,</span><span class="w"> </span><span class="n">PINMUX_FUNCTION_KEY_COLx</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Set row pads to pull-up, and set key row pinmux function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PAD_PullCtrl</span><span class="p">(</span><span class="n">pad_rowx</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PuPd_UP</span><span class="p">);</span>
<span class="n">Pinmux_Config</span><span class="p">(</span><span class="n">pad_rowx</span><span class="p">,</span><span class="w"> </span><span class="n">PINMUX_FUNCTION_KEY_ROWx</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p>Initialize Key-Scan parameters.</p>
<p>Select key row number and column number (one bit one row or column) according to keypads, and set work mode to event trigger mode, etc.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">KeyScan_StructInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">KeyScan_InitStruct</span><span class="p">);</span>
<span class="n">KeyScan_InitStruct</span><span class="p">.</span><span class="n">KS_ColSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span><span class="w">  </span><span class="c1">//8 columns</span>
<span class="n">KeyScan_InitStruct</span><span class="p">.</span><span class="n">KS_RowSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span><span class="w">  </span><span class="c1">//8 rows</span>
<span class="n">KeyScan_InitStruct</span><span class="p">.</span><span class="n">KS_WorkMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KS_EVENT_TRIGGER_MODE</span><span class="p">;</span>
<span class="n">KeyScan_Init</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">KeyScan_InitStruct</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Enable Key-Scan interrupt and register Key-Scan interrupt handle.</p></li>
<li><p>Enable Key-Scan.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">KeyScan_Cmd</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Wait Key-Scan interrupt, and handle Key-Scan interrupts.</p></li>
</ol>
</section>
<section id="regular-scan-mode">
<h2>Regular Scan Mode<a class="headerlink" href="#regular-scan-mode" title="Link to this heading"></a></h2>
<p>To use Key-Scan regular scan mode, perform the following procedures:</p>
<ol class="arabic">
<li><p>Configure Pinmux for Key-Scan keypads.</p>
<ol class="loweralpha">
<li><p>Set column pads to no-pull, and set column pinmux function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PAD_PullCtrl</span><span class="p">(</span><span class="n">pad_colx</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PuPd_NOPULL</span><span class="p">);</span>
<span class="n">Pinmux_Config</span><span class="p">(</span><span class="n">pad_colx</span><span class="p">,</span><span class="w"> </span><span class="n">PINMUX_FUNCTION_KEY_COLx</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Set row pads to pull-up, and set key row pinmux function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PAD_PullCtrl</span><span class="p">(</span><span class="n">pad_rowx</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PuPd_UP</span><span class="p">);</span>
<span class="n">Pinmux_Config</span><span class="p">(</span><span class="n">pad_rowx</span><span class="p">,</span><span class="w"> </span><span class="n">PINMUX_FUNCTION_KEY_ROWx</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p>Initialize Key-Scan parameters.</p>
<p>Select key row number and column number (one bit one row or column) according to keypads, set work mode to regular scan mode, etc.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">KeyScan_StructInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">KeyScan_InitStruct</span><span class="p">);</span>
<span class="n">KeyScan_InitStruct</span><span class="p">.</span><span class="n">KS_ColSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span><span class="w">  </span><span class="c1">//8 columns</span>
<span class="n">KeyScan_InitStruct</span><span class="p">.</span><span class="n">KS_RowSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span><span class="w">  </span><span class="c1">//8 rows</span>
<span class="n">KeyScan_InitStruct</span><span class="p">.</span><span class="n">KS_WorkMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KS_REGULAR_SCAN_MODE</span><span class="p">;</span>
<span class="n">KeyScan_Init</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">KeyScan_InitStruct</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Enable Key-Scan interrupt and register Key-Scan interrupt handle.</p></li>
<li><p>Enable Key-Scan.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">KeyScan_Cmd</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Wait Key-Scan interrupt, and handle Key-Scan interrupts.</p></li>
</ol>
</section>
<section id="key-stuck">
<h2>Key Stuck<a class="headerlink" href="#key-stuck" title="Link to this heading"></a></h2>
<p>When existing key stuck, perform the following procedures:</p>
<ol class="arabic">
<li><p>Configure Pinmux for Key-Scan keypads.</p>
<ol class="loweralpha">
<li><p>Set column pads to no-pull, and set column pinmux function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PAD_PullCtrl</span><span class="p">(</span><span class="n">pad_colx</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PuPd_NOPULL</span><span class="p">);</span>
<span class="n">Pinmux_Config</span><span class="p">(</span><span class="n">pad_colx</span><span class="p">,</span><span class="w"> </span><span class="n">PINMUX_FUNCTION_KEY_COLx</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Set row pads to pull-up, and set key row pinmux function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PAD_PullCtrl</span><span class="p">(</span><span class="n">pad_rowx</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PuPd_UP</span><span class="p">);</span>
<span class="n">Pinmux_Config</span><span class="p">(</span><span class="n">pad_rowx</span><span class="p">,</span><span class="w"> </span><span class="n">PINMUX_FUNCTION_KEY_ROWx</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p>Initialize Key-Scan parameters.</p>
<p>Select key row number and column number (one bit one row or column) according to keypads, set work mode to regular scan mode, etc.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">KeyScan_StructInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">KeyScan_InitStruct</span><span class="p">);</span>
<span class="n">KeyScan_InitStruct</span><span class="p">.</span><span class="n">KS_ColSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span><span class="w">  </span><span class="c1">//8 columns</span>
<span class="n">KeyScan_InitStruct</span><span class="p">.</span><span class="n">KS_RowSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span><span class="w">  </span><span class="c1">//8 rows</span>
<span class="n">KeyScan_Init</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">KeyScan_InitStruct</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Enable Key-Scan stuck auto check function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">KeyScan_StuckAutoCmd</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Set stuck time threshold, and configure stuckrow detect time and interval time.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">KeyScan_SetStuckThreshold</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span><span class="w">  </span><span class="c1">//stuck time threshold: 10ms</span>
<span class="n">KeyScan_StuckPeriodicalPull</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">);</span><span class="c1">//pull time:2000us, no pull time:4000us</span>
</pre></div>
</div>
</li>
<li><p>Enable Key-Scan stuck and all default interrupt and register Key-Scan interrupt handle.</p></li>
<li><p>Enable Key-Scan.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">KeyScan_Cmd</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Wait Key-Scan interrupt, and handle Key-Scan interrupts.</p>
<ul>
<li><p>In stuck event interrupt, get row status, and set row default status to indicate stuck row, then mask all the keys of the stuck row.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">row_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyScan_GetStuckRow</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">);</span>
<span class="n">KeyScan_SetStuckRow</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="n">row_status</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>In all default interrupt, reset row default status to initial value, disable stuck event interrupt and all default interrupt, enable scan event interrupt and all release interrupt, then other keys except the stuck key can work normally.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">KeyScan_INTConfig</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="n">KS_BIT_ALL_DEFAULT_INT_MASK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">KS_BIT_STUCK_EVENT_INT_MASK</span><span class="p">,</span><span class="w"> </span><span class="n">DISABLE</span><span class="p">);</span>
<span class="n">KeyScan_SetStuckRow</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="n">KeyScan_INTConfig</span><span class="p">(</span><span class="n">KeyScan</span><span class="p">,</span><span class="w"> </span><span class="n">KS_BIT_ALL_RELEASE_INT_MASK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">KS_BIT_SCAN_EVENT_INT_MASK</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Key or keys except the stuck press or release will generate the corresponding interrupt normally.</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Key-Scan" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../audio/src/index.html" class="btn btn-neutral float-right" title="Audio" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Realsil.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>