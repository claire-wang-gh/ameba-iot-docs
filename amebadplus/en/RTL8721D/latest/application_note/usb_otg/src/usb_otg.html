<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; amebadplus_docs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/toggleprompt.js?v=d7ede5d2"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Wi-Fi" href="../../wifi/index.html" />
    <link rel="prev" title="USB OTG" href="index.html" />  
     
  <script type="text/javascript" src="../../../_static/js/selector.js"></script>
<style>
      .wy-nav-content {
      max-width: 1000px; /* 设置最大宽度 */
      }
</style>



</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            amebadplus_docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../product_overview/src/index.html">Product Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_start/src/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/at_command/src/index.html">AT Command</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Application Note</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../gcc_build_environment/src/index.html">GCC Build Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdk_architecture/src/index.html">SDK Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gcc_makefile/src/index.html">GCC Makefile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdk_example/src/index.html">SDK Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flash_memory_layout/index.html">Flash and Memory Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mpu_cache/src/index.html">MPU and Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../file_system/src/index.html">Virtual File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mp_image/src/index.html">MP Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ota/src/index.html">OTA Firmware Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chip_en/src/index.html">CHIP Enable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boot_process/src/index.html">Boot Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_config/src/index.html">User Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hardware_crypto_engine/src/index.html">Hardware Crypto Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../otpc/src/index.html">One-time Programmable Controller (OTPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../power_save/src/index.html">Power Saving</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ipc/src/index.html">Inter-Processor Communication (IPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dmac/src/index.html">Direct Memory Access Controller (DMAC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../psram/src/index.html">Pseudo-Static Random Access Memory (PSRAM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gpio/gpio/src/index.html">General Purpose Input/Output (GPIO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gpio/pinctrl/src/index.html">Pin Controller (Pinctrl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pinmux/src/index.html">Pin Multiplexing Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rtc_io/src/index.html">RTC_IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ir/src/index.html">Infrared Radiation (IR)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ledc/src/index.html">Light Emitting Diode Controller (LEDC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../trng/src/index.html">True Random Number Generator (TRNG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../adc/src/index.html">Analog-to-Digital Converter (ADC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cap_touch/src/index.html">Cap-Touch Controller (CTC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../key_scan/src/index.html">Key-Scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../audio/src/index.html">Audio</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">USB OTG</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#features">Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation">Implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usb-hal-apis">USB HAL APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apis-for-core-driver">APIs for Core Driver</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#usb-device-apis">USB Device APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#core-apis">Core APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#class-apis">Class APIs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#design-suggestions">Design Suggestions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../wifi/index.html">Wi-Fi</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/software_tools/index.html">Software Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/mp_tools/src/index.html">MP Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/rst_syntax/src/template_rst_syntax.html">reStructuredText</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">amebadplus_docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Application Note</a></li>
          <li class="breadcrumb-item"><a href="index.html">USB OTG</a></li>
      <li class="breadcrumb-item active">Introduction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/application_note/usb_otg/src/usb_otg.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<span id="usb-otg"></span><h1>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h1>
<p>USB OTG is the abbreviation for Universal Serial Bus On-The-Go.</p>
<section id="features">
<h2>Features<a class="headerlink" href="#features" title="Link to this heading"></a></h2>
<p>The features of Realtek USB stack are listed below:</p>
<ul class="simple">
<li><p>USB 2.0 full-speed device mode</p></li>
<li><p>Unified HAL API for all Realtek Ameba SoC series</p></li>
<li><p>Device-only API for class and application development</p></li>
<li><p>Device classes: CDC ACM, Composite and HID</p></li>
<li><p>Device descriptor full customizable</p></li>
<li><p>NOT supported: OTG/host mode, high/low-speed device mode</p></li>
</ul>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading"></a></h2>
<p>The software architecture of USB stack is illustrated below:</p>
<figure class="align-center" id="id9">
<a class="reference internal image-reference" href="../../../_images/usb_stack_architecture.svg"><img alt="../../../_images/usb_stack_architecture.svg" height="235" src="../../../_images/usb_stack_architecture.svg" width="475" /></a>
<figcaption>
<p><span class="caption-text">USB stack architecture</span><a class="headerlink" href="#id9" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The function of each layer:</p>
<ul class="simple">
<li><p><strong>USB HAL driver</strong>: implements the SoC-specific USB functions and provides unified USB HAL API for USB device core drivers</p></li>
<li><p><strong>USB device core driver</strong>: implements the USB device-specific functions and provides unified USB device API for USB device classes</p></li>
<li><p><strong>USB class</strong>: implements the USB classes as per USB IF specifications</p></li>
<li><p><strong>USB application</strong>: implements the USB applications corresponding with the USB classes</p></li>
</ul>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h2>
<p>The USB stack is implemented in the following files:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>Transfer</p></th>
<th class="head"><p>Class directory</p></th>
<th class="head"><p>Application directory</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CDC ACM</p></td>
<td><p>CTRL, BULK IN/OUT, INTR IN</p></td>
<td><p>component\usb\device\cdc_acm</p></td>
<td><p>component\example\usb\usbd_cdc_acm</p></td>
</tr>
<tr class="row-odd"><td><p>Composite</p></td>
<td><p>CTRL, BULK IN/OUT, INTR IN/OUT</p></td>
<td><p>component\usb\device\composite</p></td>
<td><p>component\example\usb\usbd_composite</p></td>
</tr>
<tr class="row-even"><td><p>HID</p></td>
<td><p>CTRL, INTR IN/OUT</p></td>
<td><p>component\usb\devicehid</p></td>
<td><p>component\example\usb\usbd_hid</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="configuration">
<h1>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h1>
<ol class="arabic">
<li><p>Type <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">menuconfig</span></code> command under <code class="docutils literal notranslate"><span class="pre">{SDK}\amebadplus_gcc_project</span></code>, then select <code class="docutils literal notranslate"><span class="pre">MENUCONFIG</span> <span class="pre">FOR</span> <span class="pre">KM4</span> <span class="pre">CONFIG</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">CONFIG</span> <span class="pre">USB</span></code>:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../../_images/usb_configuration_menu_entry.png"><img alt="../../../_images/usb_configuration_menu_entry.png" src="../../../_images/usb_configuration_menu_entry.png" style="width: 423.5px; height: 244.99999999999997px;" /></a>
</figure>
</li>
</ol>
<ol class="arabic" id="usb-implementation-configuration-step-2" start="2">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Enable</span> <span class="pre">USB</span> <span class="pre">Device</span></code>, then choose the desired USB class:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../../_images/usb_configuration.png"><img alt="../../../_images/usb_configuration.png" src="../../../_images/usb_configuration.png" style="width: 422.79999999999995px; height: 245.7px;" /></a>
</figure>
</li>
<li><p>Type <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span> <span class="pre">EXAMPLE=&lt;example&gt;</span></code> command under GCC auto build project to build image with USB application.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;example&gt;</span></code> is the folder name under <code class="docutils literal notranslate"><span class="pre">component/example/usb</span></code>, and shall correspond to the mode and class configuration in Step <a class="reference internal" href="#usb-implementation-configuration-step-2"><span class="std std-ref">2</span></a>.</p>
</div>
</li>
</ol>
</section>
<section id="usb-hal-apis">
<h1>USB HAL APIs<a class="headerlink" href="#usb-hal-apis" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>The USB HAL APIs provide unified interfaces for upper layer USB device core drivers to access SoC-specific USB hardware.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../../_images/usb_hal_api.svg"><img alt="../../../_images/usb_hal_api.svg" height="204" src="../../../_images/usb_hal_api.svg" width="561" /></a>
</figure>
</section>
<section id="apis-for-core-driver">
<h2>APIs for Core Driver<a class="headerlink" href="#apis-for-core-driver" title="Link to this heading"></a></h2>
<p>Header file: <code class="docutils literal notranslate"><span class="pre">{SDK}\component\soc\amebadplus\fwlib\include\ameba_usb.h</span></code></p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">usb_chip_init</span></code></p></td>
<td><p>SoC-specific USB initialization</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">usb_chip_deinit</span></code></p></td>
<td><p>SoC-specific USB de-initialization</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="usb-device-apis">
<h1>USB Device APIs<a class="headerlink" href="#usb-device-apis" title="Link to this heading"></a></h1>
<section id="id1">
<h2>Overview<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<figure class="align-center">
<a class="reference internal image-reference" href="../../../_images/usb_device_api.svg"><img alt="../../../_images/usb_device_api.svg" height="387" src="../../../_images/usb_device_api.svg" width="925" /></a>
</figure>
</section>
<section id="core-apis">
<h2>Core APIs<a class="headerlink" href="#core-apis" title="Link to this heading"></a></h2>
<p>Header file: <code class="docutils literal notranslate"><span class="pre">{SDK}\component\usb\device\core\usbd.h</span></code></p>
<section id="apis-for-class">
<h3>APIs for Class<a class="headerlink" href="#apis-for-class" title="Link to this heading"></a></h3>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>usbd_register_class</p></td>
<td><p>Register a class, the class is defined by type usbd_class_driver_t,
refer to Section <a class="reference internal" href="#usb-device-api-callback-class"><span class="std std-ref">Class Callback</span></a> for details.</p></td>
</tr>
<tr class="row-odd"><td><p>usbd_unregister_class</p></td>
<td><p>Unregister a class</p></td>
</tr>
<tr class="row-even"><td><p>usbd_ep_init</p></td>
<td><p>Initialize an endpoint</p></td>
</tr>
<tr class="row-odd"><td><p>usbd_ep_deinit</p></td>
<td><p>De-initialize an endpoint</p></td>
</tr>
<tr class="row-even"><td><p>usbd_ep_transmit</p></td>
<td><p>Transmit data to an endpoint</p></td>
</tr>
<tr class="row-odd"><td><p>usbd_ep_receive</p></td>
<td><p>Prepare to receive data from an endpoint</p></td>
</tr>
<tr class="row-even"><td><p>usbd_ep_set_stall</p></td>
<td><p>Set an endpoint to STALL state</p></td>
</tr>
<tr class="row-odd"><td><p>usbd_ep_clear_stall</p></td>
<td><p>Clear the STALL state of an endpoint</p></td>
</tr>
<tr class="row-even"><td><p>usbd_ep_is_stall</p></td>
<td><p>Check whether the endpoint is in STALL state</p></td>
</tr>
<tr class="row-odd"><td><p>usbd_ep0_set_stall</p></td>
<td><p>Set endpoint 0 to STALL state</p></td>
</tr>
<tr class="row-even"><td><p>usbd_ep0_transmit</p></td>
<td><p>Transmit data to endpoint 0, i.e. control endpoint</p></td>
</tr>
<tr class="row-odd"><td><p>usbd_ep0_receive</p></td>
<td><p>Prepare to receive data from endpoint 0, i.e. control endpoint</p></td>
</tr>
<tr class="row-even"><td><p>usbd_ep0_transmit_status</p></td>
<td><p>Transmit status to endpoint 0, i.e. control endpoint</p></td>
</tr>
<tr class="row-odd"><td><p>usbd_ep0_receive_status</p></td>
<td><p>Prepare to receive status from endpoint 0, i.e. control endpoint</p></td>
</tr>
<tr class="row-even"><td><p>usbd_get_str_desc</p></td>
<td><p>Used for class to transfer ASCII string to USB string descriptor format in UNICODE 16</p></td>
</tr>
</tbody>
</table>
</section>
<section id="class-callback">
<span id="usb-device-api-callback-class"></span><h3>Class Callback<a class="headerlink" href="#class-callback" title="Link to this heading"></a></h3>
<p>The USB device class is defined by type <code class="docutils literal notranslate"><span class="pre">usbd_class_driver_t</span></code> as a group of callbacks:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_usbd_class_driver_t</span><span class="w"> </span><span class="p">{</span>
<span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_descriptor</span><span class="p">)(</span><span class="w"> </span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">usb_setup_req_t</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span>
<span class="n">usb_speed_type_t</span><span class="w"> </span><span class="n">speed</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="o">*</span><span class="n">len</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">set_config</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">clear_config</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">usb_setup_req_t</span><span class="w">  </span><span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">sof</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">ep0_data_in</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">ep0_data_out</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">ep_data_in</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">ep_addr</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="n">ep_data_out</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">ep_addr</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">status_changed</span><span class="p">)(</span><span class="n">usb_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">usbd_class_driver_t</span><span class="p">;</span>
</pre></div>
</div>
<p>Description of the callbacks:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>get_descriptor</p></td>
<td><p>Get device descriptor</p></td>
</tr>
<tr class="row-odd"><td><p>set_config</p></td>
<td><p>Called when device core sets configuration, e.g. SET_CONFIGURATION request received at addressed state</p></td>
</tr>
<tr class="row-even"><td><p>clear_config</p></td>
<td><p>Called when device core clears configuration, e.g. SET_CONFIGURATION request with a new configuration received at configured state</p></td>
</tr>
<tr class="row-odd"><td><p>setup</p></td>
<td><p>Called at setup phase of a control transfer, used for class-specific request handling</p></td>
</tr>
<tr class="row-even"><td><p>ep_data_in</p></td>
<td><p>Called at data in phase of a transfer, used to inform the class that the data transmit is done</p></td>
</tr>
<tr class="row-odd"><td><p>ep_data_out</p></td>
<td><p>Called at data out phase of a transfer, used to inform the class to handle the received data</p></td>
</tr>
<tr class="row-even"><td><p>ep0_data_in</p></td>
<td><p>Called at data in phase of a control transfer, used to inform the class that the control data transmit is done</p></td>
</tr>
<tr class="row-odd"><td><p>ep0_data_out</p></td>
<td><p>Called at data out phase of a control transfer, used to inform the class to handle the received control data</p></td>
</tr>
<tr class="row-even"><td><p>sof</p></td>
<td><p>Called at SOF interrupt, used for class-specific SOF handling</p></td>
</tr>
<tr class="row-odd"><td><p>suspend</p></td>
<td><p>Called at suspend interrupt, used for class-specific suspend handling</p></td>
</tr>
<tr class="row-even"><td><p>resume</p></td>
<td><p>Called at resume interrupt, used for class-specific resume handling</p></td>
</tr>
<tr class="row-odd"><td><p>status_changed</p></td>
<td><p>Called at USB attach status changed</p></td>
</tr>
</tbody>
</table>
</section>
<section id="apis-for-application">
<h3>APIs for Application<a class="headerlink" href="#apis-for-application" title="Link to this heading"></a></h3>
<section id="usbd-config-t">
<h4>usbd_config_t<a class="headerlink" href="#usbd-config-t" title="Link to this heading"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">u8</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w">               </span><span class="cm">/* USB speed:</span>
<span class="cm">                             USB_SPEED_HIGH: high speed</span>
<span class="cm">                             USB_SPEED_HIGH_IN_FULL: full speed */</span>
<span class="w">     </span><span class="n">u8</span><span class="w"> </span><span class="n">dma_enable</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Enable USB internal DMA mode,</span>
<span class="cm">                             0-Disable, 1-Enable */</span>
<span class="w">     </span><span class="n">u8</span><span class="w"> </span><span class="n">isr_priority</span><span class="p">;</span><span class="w">        </span><span class="cm">/* USB ISR thread priority */</span>
<span class="w">     </span><span class="n">u8</span><span class="w"> </span><span class="n">intr_use_ptx_fifo</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Use Periodic TxFIFO for INTR IN</span>
<span class="cm">                             transfer */</span>
<span class="w">     </span><span class="n">u32</span><span class="w"> </span><span class="n">rx_fifo_depth</span><span class="p">;</span><span class="w">      </span><span class="cm">/* RX FIFO depth */</span>
<span class="w">     </span><span class="n">u32</span><span class="w"> </span><span class="n">nptx_fifo_depth</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Non-Periodical TX FIFO depth */</span>
<span class="w">     </span><span class="n">u32</span><span class="w"> </span><span class="n">ptx_fifo_depth</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Periodical TX FIFO depth */</span>
<span class="w">     </span><span class="n">u32</span><span class="w"> </span><span class="n">ext_intr_en</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Enable extra USB interrupts:</span>
<span class="cm">                                 BIT0: USBD_SOF_INTR, GINTSTS.bit3</span>
<span class="cm">                                 BIT1: USBD_EOPF_INTR, GINTSTS.bit15</span>
<span class="cm">                                 BIT2: USBD_EPMIS_INTR, GINTSTS.bit17</span>
<span class="cm">                                 BIT3: USBD_ICII_INTR, GINTSTS.bit20</span>
<span class="cm">                                 */</span>
<span class="w">     </span><span class="n">u8</span><span class="w"> </span><span class="n">nptx_max_epmis_cnt</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Max Non-Periodical TX transfer EPMIS</span>
<span class="cm">                             interrupt count allowed, EPMIS</span>
<span class="cm">                             interrupt will be handled only if the</span>
<span class="cm">                             EPMIS interrupt count is higher than</span>
<span class="cm">                             this value and USBD_EPMIS_INTR is</span>
<span class="cm">                             enabled in ext_intr_en */</span>
<span class="w">     </span><span class="n">u8</span><span class="w"> </span><span class="n">nptx_max_err_cnt</span><span class="p">[</span><span class="n">USB_MAX_ENDPOINTS</span><span class="p">];</span><span class="w"> </span><span class="cm">/* Max Non-Periodical</span>
<span class="cm">                                             TX transfer error count allowed for</span>
<span class="cm">                                             each endpoint, if endpoint transfer</span>
<span class="cm">                                             error count is higher than this value,</span>
<span class="cm">                                             the transfer status will be</span>
<span class="cm">                                             determined as failed */</span>
<span class="p">}</span><span class="w"> </span><span class="n">usbd_config_t</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>usbd_init</p></td>
<td><p>Initialize USB device stack with configuration defined by type <code class="docutils literal notranslate"><span class="pre">usbd_config_t</span></code> above.</p>
<p>For DFIFO configuration, only two options are suggested:</p>
<ul>
<li><p>RX FIFO sacrifice, only if the periodic ISOC/INTR packet size has to be 1024 byte</p>
<p>rx_fifo_depth = 504</p>
<p>nptx_fifo_depth = 256</p>
<p>ptx_fifo_depth = 256</p>
</li>
<li><p>PTX FIFO sacrifice, for all other situations</p>
<p>rx_fifo_depth = 512</p>
<p>nptx_fifo_depth = 256</p>
<p>ptx_fifo_depth = 248</p>
</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>usbd_deinit</p></td>
<td><p>De-initialize USB device stack</p></td>
</tr>
<tr class="row-even"><td><p>usbd_get_status</p></td>
<td><p>Get attach status, the return value is defined by type <code class="docutils literal notranslate"><span class="pre">usbd_attach_status_t</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">enum</span> <span class="p">{</span>
  <span class="n">USBD_ATTACH_STATUS_INIT</span>      <span class="o">=</span> <span class="mi">0</span><span class="n">U</span><span class="p">,</span>  <span class="o">//</span> <span class="n">Initialized</span>
  <span class="n">USBD_ATTACH_STATUS_ATTACHED</span> <span class="o">=</span> <span class="mi">1</span><span class="n">U</span><span class="p">,</span>   <span class="o">//</span> <span class="n">Attached</span> <span class="n">to</span> <span class="n">host</span>
  <span class="n">USBD_ATTACH_STATUS_DETACHED</span> <span class="o">=</span> <span class="mi">2</span><span class="n">U</span>    <span class="o">//</span> <span class="n">Detached</span> <span class="kn">from</span> <span class="nn">host</span>
<span class="p">}</span> <span class="n">usbd_attach_status_t</span><span class="p">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>usbd_get_bus_status</p></td>
<td><p>Get USB bus status, the status argument returns the bit combined value of type <code class="docutils literal notranslate"><span class="pre">usbd_bus_state_t</span></code> when the function return value
is HAL_OK:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">enum</span> <span class="p">{</span>
  <span class="n">USBD_BUS_STATUS_DN</span>       <span class="o">=</span> <span class="n">BIT0</span><span class="p">,</span>  <span class="o">//</span> <span class="n">D</span><span class="o">-</span>
  <span class="n">USBD_BUS_STATUS_DP</span>       <span class="o">=</span> <span class="n">BIT1</span><span class="p">,</span>  <span class="o">//</span> <span class="n">D</span><span class="o">+</span>
  <span class="n">USBD_BUS_STATUS_SUSPEND</span>  <span class="o">=</span> <span class="n">BIT2</span><span class="p">,</span>  <span class="o">//</span> <span class="n">suspend</span> <span class="n">indication</span>
  <span class="p">}</span> <span class="n">usbd_bus_state_t</span><span class="p">;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>usbd_wake_host</p></td>
<td><p>Send a remote wakeup signal to USB host</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="application-callback">
<h3>Application Callback<a class="headerlink" href="#application-callback" title="Link to this heading"></a></h3>
<p>N/A</p>
</section>
</section>
<section id="class-apis">
<h2>Class APIs<a class="headerlink" href="#class-apis" title="Link to this heading"></a></h2>
<section id="cdc-acm">
<h3>CDC ACM<a class="headerlink" href="#cdc-acm" title="Link to this heading"></a></h3>
<p>Header file: <code class="docutils literal notranslate"><span class="pre">{SDK}\component\usb\device\cdc_acm\usbd_cdc_acm.h</span></code></p>
<section id="api-for-application">
<h4>API for Application<a class="headerlink" href="#api-for-application" title="Link to this heading"></a></h4>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>usbd_cdc_acm_init</p></td>
<td><p>Initialize the class with parameters:</p>
<ul class="simple">
<li><p>RX buffer length (rx_buf_len): BULK OUT buffer length</p></li>
<li><p>TX buffer length (tx_buf_len): BULK IN buffer length</p></li>
<li><p>Application callback (cb): refer to 1.4.3.1.2 for details</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>usbd_cdc_acm_deinit</p></td>
<td><p>De-initialize the class</p></td>
</tr>
<tr class="row-even"><td><p>usbd_cdc_acm_transmit</p></td>
<td><p>Transmit BULK IN data to host, the data length shall not be larger than the TX buffer length</p></td>
</tr>
<tr class="row-odd"><td><p>usbd_cdc_acm_notify_serial_state</p></td>
<td><p>Send INTR IN data to notify device serial state to host</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id2">
<h4>Application Callback<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<p>CDC ACM class provides callbacks for user application, the callbacks are defined by type <code class="docutils literal notranslate"><span class="pre">usbd_cdc_acm_cb_t</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">init</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">deinit</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">setup</span><span class="p">)(</span><span class="n">usb_setup_req_t</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">received</span><span class="p">)(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">transmitted</span><span class="p">)(</span><span class="n">u8</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">status_changed</span><span class="p">)(</span><span class="n">u8</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">usbd_cdc_acm_cb_t</span><span class="p">;</span>
</pre></div>
</div>
<p>Description of the callbacks:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>init</p></td>
<td><p>Called at the end of class initialization flow, for application-specific initialization</p></td>
</tr>
<tr class="row-odd"><td><p>deinit</p></td>
<td><p>Called at the beginning of class de-initialization flow, for application-specific de-initialization</p></td>
</tr>
<tr class="row-even"><td><p>setup</p></td>
<td><p>Called at setup phase or data out phase of class-specific control requests, for application-specific setup</p></td>
</tr>
<tr class="row-odd"><td><p>received</p></td>
<td><p>Called when BULK OUT transfer completed, for application to handle the received data</p></td>
</tr>
<tr class="row-even"><td><p>transmitted</p></td>
<td><p>Called when BULK IN transfer completed, indicates application the transfer status</p></td>
</tr>
<tr class="row-odd"><td><p>status_changed</p></td>
<td><p>Called when USB attach status changed, for application to support hot plug</p></td>
</tr>
</tbody>
</table>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h4>
<p>An example is provided for users to use CDC ACM device class. The example turns AmebaDPlus into a virtual serial port for PC, common serial port tools such as Tera Term can be used to communicate with AmebaDPlus, and AmebaDPlus will echo back the message sent to it.</p>
<p>Refer to the readme.txt file of the example for details.</p>
</section>
</section>
<section id="composite">
<h3>Composite<a class="headerlink" href="#composite" title="Link to this heading"></a></h3>
<p>Header files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;SDK&gt;\component\usb\device\composite\usbd_composite.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;SDK&gt;\component\usb\device\composite\usbd_composite_cdc_acm.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;SDK&gt;\component\usb\device\composite\usbd_composite_hid.h</span></code></p></li>
</ul>
<section id="id3">
<h4>API for Application<a class="headerlink" href="#id3" title="Link to this heading"></a></h4>
<p>General API:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>usbd_composite_init</p></td>
<td><p>Initialize the class with parameters:</p>
<ul class="simple">
<li><p>cdc_bulk_out_xfer_size: CDC ACM BULK OUT transfer length</p></li>
<li><p>cdc_bulk_in_xfer_size: CDC ACM BULK IN transfer length</p></li>
<li><p>cdc_cb: CDC ACM application callback, refer to 1.4.3.2.2 for details</p></li>
<li><p>hid_intr_in_xfer_size: HID INTR IN transfer length</p></li>
<li><p>hid_cb: HID application callback, refer to 1.4.3.2.2 for details</p></li>
<li><p>cb: Composite application callback, refer to 1.4.3.2.2 for details</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>usbd_composite_deinit</p></td>
<td><p>De-initialize the class</p></td>
</tr>
</tbody>
</table>
<p>CDC ACM interface API:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>usbd_composite_cdc_acm_transmit</p></td>
<td><p>Transmit BULK IN data to host, the data length shall not be larger than the TX buffer length</p></td>
</tr>
<tr class="row-odd"><td><p>usbd_composite_cdc_acm_notify_serial_state</p></td>
<td><p>Send INTR IN data to notify device serial state to host</p></td>
</tr>
</tbody>
</table>
<p>HID interface API:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>usbd_composite_hid_send_data</p></td>
<td><p>Transmit INTR IN data to host, the data length shall not be larger than the TX buffer length</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id4">
<h4>Application Callback<a class="headerlink" href="#id4" title="Link to this heading"></a></h4>
<p>Composite class provides callbacks for user application, the callbacks are defined by two types:</p>
</section>
<section id="usbd-cdc-acm-cb-t">
<h4>usbd_cdc_acm_cb_t<a class="headerlink" href="#usbd-cdc-acm-cb-t" title="Link to this heading"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">init</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">deinit</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">setup</span><span class="p">)(</span><span class="n">usb_setup_req_t</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">received</span><span class="p">)(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">usbd_cdc_acm_cb_t</span><span class="p">;</span>
</pre></div>
</div>
<p>Description of the callbacks:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>init</p></td>
<td><p>Called at the end of class initialization flow, for application-specific initialization</p></td>
</tr>
<tr class="row-odd"><td><p>deinit</p></td>
<td><p>Called at the beginning of class de-initialization flow, for application-specific de-initialization</p></td>
</tr>
<tr class="row-even"><td><p>setup</p></td>
<td><p>Called at setup phase or data out phase of class-specific control requests, for application-specific setup</p></td>
</tr>
<tr class="row-odd"><td><p>received</p></td>
<td><p>Called at data out phase of BULK OUT transfer, for application to handle the received data</p></td>
</tr>
</tbody>
</table>
</section>
<section id="usbd-hid-usr-cb-t">
<h4>usbd_hid_usr_cb_t<a class="headerlink" href="#usbd-hid-usr-cb-t" title="Link to this heading"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">init</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">deinit</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">u8</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">setup</span><span class="p">)(</span><span class="n">usb_setup_req_t</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">transmitted</span><span class="p">)(</span><span class="n">u8</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">usbd_hid_usr_cb_t</span><span class="p">;</span>
</pre></div>
</div>
<p>Description of the callbacks:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>init</p></td>
<td><p>Called at the end of class initialization flow, for application-specific initialization</p></td>
</tr>
<tr class="row-odd"><td><p>deinit</p></td>
<td><p>Called at the beginning of class de-initialization flow, for application-specific de-initialization</p></td>
</tr>
<tr class="row-even"><td><p>setup</p></td>
<td><p>Called at setup phase or data out phase of class-specific control requests, for application-specific setup</p></td>
</tr>
<tr class="row-odd"><td><p>transmitted</p></td>
<td><p>Called at data in phase of INTR IN transfer to inform the application that the INTR IN transfer is done</p></td>
</tr>
</tbody>
</table>
</section>
<section id="usbd-composite-cb-t">
<h4>usbd_composite_cb_t<a class="headerlink" href="#usbd-composite-cb-t" title="Link to this heading"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">status_changed</span><span class="p">)(</span><span class="n">u8</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">usbd_composite_cb_t</span><span class="p">;</span>
</pre></div>
</div>
<p>Description of the callbacks:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>status_changed</p></td>
<td><p>Called when USB attach status changed, for application to support hot plug</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id5">
<h4>Example<a class="headerlink" href="#id5" title="Link to this heading"></a></h4>
<p>An example is provided for user to use Composite device class. The example turns AmebaDPlus into a CDC ACM and HID composite device. Refer to the readme.txt file of the example for details.</p>
</section>
</section>
<section id="hid">
<h3>HID<a class="headerlink" href="#hid" title="Link to this heading"></a></h3>
<p>Header file: <code class="docutils literal notranslate"><span class="pre">{SDK}\component\usb\device\hid\usbd_hid.h</span></code></p>
<section id="id6">
<h4>APIs for Application<a class="headerlink" href="#id6" title="Link to this heading"></a></h4>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>usbd_hid_init</p></td>
<td><p>Initialize the class with parameters:</p>
<ul class="simple">
<li><p>TX buffer length (tx_buf_len): INTR IN buffer length</p></li>
<li><p>Application callback (cb): refer to 1.4.3.3.2 for details</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>usbd_hid_deinit</p></td>
<td><p>De-initialize the class</p></td>
</tr>
<tr class="row-even"><td><p>usbd_hid_send_data</p></td>
<td><p>Transmit INTR IN data to host, the data length shall not be larger than the TX buffer length</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id7">
<h4>Application Callback<a class="headerlink" href="#id7" title="Link to this heading"></a></h4>
<p>HID class provides callbacks for user application, the callbacks are defined by type <code class="docutils literal notranslate"><span class="pre">usbd_hid_usr_cb_t</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">init</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">deinit</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">setup</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">transmitted</span><span class="p">)(</span><span class="n">u8</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="cp">#if HID_DEVICE_TYPE == HID_KEYBOARD_DEVICE</span>
<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">received</span><span class="p">)(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">status_changed</span><span class="p">)(</span><span class="n">u8</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">usbd_hid_usr_cb_t</span><span class="p">;</span>
</pre></div>
</div>
<p>Description of the callbacks:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>init</p></td>
<td><p>Called at the end of class initialization flow, for application-specific initialization</p></td>
</tr>
<tr class="row-odd"><td><p>deinit</p></td>
<td><p>Called at the beginning of class de-initialization flow, for application-specific de-initialization</p></td>
</tr>
<tr class="row-even"><td><p>setup</p></td>
<td><p>Called at setup phase or data out phase of class-specific control requests, for application-specific setup</p></td>
</tr>
<tr class="row-odd"><td><p>transmitted</p></td>
<td><p>Called at data in phase of INTR IN transfer to inform the application that the INTR IN transfer is done</p></td>
</tr>
<tr class="row-even"><td><p>received</p></td>
<td><p>Called at data out phase of INTR OUT transfer to inform the application that the INTR OUT data is received</p></td>
</tr>
<tr class="row-odd"><td><p>status_changed</p></td>
<td><p>Called when USB attach status changed, for application to support hot plug</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id8">
<h4>Example<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<p>An example is provided for user to use HID device class. The example turns AmebaDPlus into a mouse for PC, simulates the mouse move, scroll, button pressed events.</p>
<p>Refer to the <code class="docutils literal notranslate"><span class="pre">readme.txt</span></code> file of the example for details.</p>
</section>
</section>
</section>
</section>
<section id="design-suggestions">
<h1>Design Suggestions<a class="headerlink" href="#design-suggestions" title="Link to this heading"></a></h1>
<p>For constant powered USB devices (e.g. battery powered devices), hot plug events shall be properly processed to avoid malfunction or memory leak.</p>
<p>USB device stack provides the following API to get USB device status for the detection of hot plug events:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u8</span><span class="w"> </span><span class="n">usbd_get_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</pre></div>
</div>
<p>And USB device examples (e.g. CDC ACM) provide examples of how to use this API to support hot plug, please refer to the corresponding configuration (e.g. <code class="docutils literal notranslate"><span class="pre">CONFIG_USDB_CDC_ACM_CHECK_USB_STATUS</span></code> for CDC ACM example) for details.</p>
<p>However, it is not recommended to support hot plug by SW in this way for final products. Instead, it is suggested to check the USB status via hardware VBUS GPIO interrupt along with the usbd_get_status API, and the strategy is described as following table.</p>
<table class="docutils align-default" id="id10" style="width: 100%">
<caption><span class="caption-text">USB status detection strategy</span><a class="headerlink" href="#id10" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Event</p></th>
<th class="head"><p>usbd_get_status</p></th>
<th class="head"><p>GPIO interrupt</p></th>
<th class="head"><p>VBUS status</p></th>
<th class="head"><p>Detected USB status</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Reset (detached)</p></td>
<td><p>USB_STATUS_INIT</p></td>
<td><ul class="simple">
<li></li>
</ul>
</td>
<td><p>OFF</p></td>
<td><p>Initial detached status</p></td>
</tr>
<tr class="row-odd"><td><p>Attach to PC</p></td>
<td><p>USB_STATUS_ATTACHED</p></td>
<td><p>Y (rising edge)</p></td>
<td><p>ON</p></td>
<td><p>Attached to PC</p></td>
</tr>
<tr class="row-even"><td><p>Detach from PC</p></td>
<td><p>USB_STATUS_DETACHED</p></td>
<td><p>Y (falling edge)</p></td>
<td><p>OFF</p></td>
<td><p>Detached</p></td>
</tr>
<tr class="row-odd"><td><p>Attach to charger</p></td>
<td><p>USB_STATUS_INIT or</p>
<p>USB_STATUS_DETACHED</p>
</td>
<td><p>Y (rising edge)</p></td>
<td><p>ON</p></td>
<td><p>Attached to charger</p></td>
</tr>
<tr class="row-even"><td><p>Detach from charger</p></td>
<td><p>USB_STATUS_DETACHED</p></td>
<td><p>Y (falling edge)</p></td>
<td><p>OFF</p></td>
<td><p>Detached</p></td>
</tr>
</tbody>
</table>
<p>By comparing the new detected USB status with the old determined USB status, the exact USB status can be determined. The detailed USB status detect flow is shown as following figure, only for reference.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../../_images/usb_status_detection_flow.svg"><img alt="../../../_images/usb_status_detection_flow.svg" height="993" src="../../../_images/usb_status_detection_flow.svg" width="1590" /></a>
</figure>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="USB OTG" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../wifi/index.html" class="btn btn-neutral float-right" title="Wi-Fi" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Realsil.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>